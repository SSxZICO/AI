<!doctype html>
<html lang="ru" data-theme="auto">
<head>
  <meta charset="utf-8">
  <title>Luma AI — Multi-Chat, Typing & Stream</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Фронтенд-only Luma AI: несколько чатов, анимация печати, плавный стрим текста, RU/EN/UZ, локальное хранение.">
  <meta name="theme-color" content="#7c5cff">
  <style>
    :root{
      --bg:#0f1020; --bg-soft:#14162c; --card:#10162a;
      --text:#e9ecf1; --muted:#a7acc0;
      --accent:#7c5cff; --accent-2:#59d2fe;
      --bubble-ai:#151936; --bubble-user:#2a2f52;
      --shadow: 0 10px 26px rgba(0,0,0,.35);
      --radius:16px; --sidebar:280px; --font:16px;
    }
    @media (prefers-color-scheme: light){
      :root[data-theme="auto"]{
        --bg:#f6f7fb; --bg-soft:#ffffff; --card:#ffffff;
        --text:#0f172a; --muted:#657084;
        --bubble-ai:#f1f2f9; --bubble-user:#e9e9ff;
        --shadow:0 10px 24px rgba(32,41,60,.08);
      }
    }
    [data-theme="light"]{
      --bg:#f6f7fb; --bg-soft:#ffffff; --card:#ffffff;
      --text:#0f172a; --muted:#657084;
      --bubble-ai:#f1f2f9; --bubble-user:#e9e9ff;
      --shadow:0 10px 24px rgba(32,41,60,.08);
    }
    [data-theme="dark"]{
      --bg:#0f1020; --bg-soft:#14162c; --card:#10162a;
      --text:#e9ecf1; --muted:#a7acc0;
      --bubble-ai:#151936; --bubble-user:#2a2f52;
      --shadow:0 10px 26px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:
        radial-gradient(1000px 500px at 10% -10%, rgba(124,92,255,.25), transparent 60%),
        var(--bg);
      color:var(--text);
      font:400 var(--font)/1.45 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }
    .app{
      display:grid; grid-template-columns: var(--sidebar) 1fr; height:100vh;
    }
    /* SIDEBAR */
    .sidebar{
      background: color-mix(in oklab, var(--bg-soft) 85%, transparent);
      border-right:1px solid color-mix(in oklab, var(--text) 18%, transparent);
      display:flex; flex-direction:column; gap:.75rem;
      padding:.75rem; position:relative; z-index:5;
    }
    .brand{
      display:flex; align-items:center; gap:.6rem; padding:.4rem .35rem .2rem;
    }
    .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent-2));box-shadow:var(--shadow);display:grid;place-items:center;color:#fff;font-weight:700}
    .brand .title{font-weight:800}
    .toolbar{display:flex; gap:.5rem; padding:.25rem .35rem}
    .btn, .icon{
      border:1px solid color-mix(in oklab, var(--text) 16%, transparent);
      background:var(--bg-soft); color:var(--text);
      padding:.55rem .7rem; border-radius:12px; cursor:pointer;
      box-shadow:var(--shadow); transition:transform .12s ease, opacity .2s ease;
    }
    .btn:hover, .icon:hover{transform:translateY(-1px)}
    .btn.primary{background:var(--accent); color:white; border-color:transparent}
    .lang{flex:1; border-radius:12px; padding:.55rem .6rem; border:1px solid color-mix(in oklab, var(--text) 16%, transparent); background:var(--bg-soft); color:var(--text)}
    .chats{overflow:auto; flex:1; display:flex; flex-direction:column; gap:.4rem; padding:.2rem}
    .chat-item{
      display:flex; align-items:center; gap:.5rem; padding:.55rem .6rem; border-radius:12px;
      border:1px solid color-mix(in oklab, var(--text) 14%, transparent);
      background:var(--card); cursor:pointer; transition:transform .12s ease, background .2s ease;
    }
    .chat-item:hover{transform:translateY(-1px)}
    .chat-item.active{outline:2px solid color-mix(in oklab, var(--accent) 80%, transparent)}
    .chat-title{flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .del{border:0;background:transparent;color:var(--muted); cursor:pointer}
    /* MAIN */
    .main{
      display:flex; flex-direction:column; min-width:0;
    }
    .topbar{
      display:flex; align-items:center; gap:.6rem; padding:.6rem .8rem;
      border-bottom:1px solid color-mix(in oklab, var(--text) 18%, transparent);
      position:sticky; top:0; backdrop-filter: blur(8px);
      background: color-mix(in oklab, var(--bg) 70%, transparent); z-index:4;
    }
    .burger{display:none}
    .top-title{font-weight:800}
    .spacer{flex:1}
    .lang2{border-radius:12px; padding:.45rem .6rem; border:1px solid color-mix(in oklab, var(--text) 16%, transparent); background:var(--bg-soft); color:var(--text)}
    .chat{
      flex:1; overflow:auto; padding:1rem; display:flex; flex-direction:column; gap:.75rem; scroll-behavior:smooth;
    }
    .row{display:flex; align-items:flex-end; gap:.5rem; animation:fadeIn .18s ease}
    @keyframes fadeIn{from{opacity:0; transform:translateY(4px)} to{opacity:1; transform:none}}
    .row.user{flex-direction:row-reverse}
    .avatar{flex:0 0 36px; width:36px; height:36px; border-radius:50%; background:var(--accent); color:#fff; display:grid; place-items:center; font-weight:700; box-shadow:var(--shadow)}
    .bubble{max-width:78ch; padding:.8rem .95rem; border-radius:16px; box-shadow:var(--shadow); line-height:1.5; white-space:pre-wrap; word-break:break-word}
    .ai .bubble{background:var(--bubble-ai)}
    .user .bubble{background:var(--bubble-user)}
    .composer{
      padding:.7rem .8rem; display:flex; gap:.5rem; border-top:1px solid color-mix(in oklab, var(--text) 18%, transparent);
      position:sticky; bottom:0; background:var(--bg);
    }
    .input{
      flex:1; display:flex; align-items:center; gap:.5rem; padding:.4rem .5rem;
      background:var(--card); border-radius:16px; box-shadow:var(--shadow); border:1px solid color-mix(in oklab, var(--text) 16%, transparent);
    }
    textarea{
      flex:1; border:0; outline:0; background:transparent; color:var(--text); font-size:1rem; line-height:1.4; resize:none; max-height:180px; padding:.6rem .7rem;
    }
    .send{border:0; border-radius:12px; padding:.65rem .95rem; font-weight:700; background:var(--accent); color:#fff; cursor:pointer; box-shadow:var(--shadow)}
    .send:hover{transform:translateY(-1px)}
    /* TYPING INDICATOR (three dots) */
    .typing{display:inline-block;height:10px;width:44px;border-radius:20px;position:relative}
    .dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:6px;background:var(--accent);opacity:.9;transform:translateY(0);animation:typing .9s infinite}
    .dot:nth-child(2){animation-delay:.12s} .dot:nth-child(3){animation-delay:.24s}
    @keyframes typing{0%{transform:translateY(0);opacity:.6}50%{transform:translateY(-6px);opacity:1}100%{transform:translateY(0);opacity:.6}}
    /* MOBILE: collapsible sidebar */
    @media (max-width: 900px){
      .app{grid-template-columns: 1fr}
      .sidebar{position:fixed; inset:0 auto 0 0; width:min(86vw, 340px); transform:translateX(-100%); transition:transform .24s ease; box-shadow:var(--shadow)}
      .sidebar.open{transform:translateX(0)}
      .burger{display:inline-block}
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <div class="logo">L</div>
        <div class="title">Luma AI</div>
      </div>
      <div class="toolbar">
        <button class="btn primary" id="newChat">＋ <span data-i="new_chat">Новый чат</span></button>
        <select class="lang" id="lang">
          <option value="ru">RU</option>
          <option value="en">EN</option>
          <option value="uz">UZ</option>
        </select>
      </div>
      <div class="chats" id="chatList"></div>
    </aside>

    <!-- Main -->
    <section class="main">
      <div class="topbar">
        <button class="icon burger" id="burger" title="Меню">☰</button>
        <div class="top-title" id="chatTitle">—</div>
        <div class="spacer"></div>
        <select class="lang2" id="lang2">
          <option value="ru">RU</option>
          <option value="en">EN</option>
          <option value="uz">UZ</option>
        </select>
      </div>

      <div class="chat" id="chat" role="log" aria-live="polite"></div>

      <form class="composer" id="composer">
        <div class="input">
          <textarea id="msg" rows="1" placeholder="Напишите сообщение…"></textarea>
        </div>
        <button class="send" type="submit" id="sendBtn">Отправить</button>
      </form>
    </section>
  </div>

  <script>
    // ================= I18N =================
    const I18N = {
      ru: {
        new_chat: "Новый чат",
        placeholder: "Напишите сообщение…",
        send: "Отправить",
        typing: "ИИ печатает…",
        untitled: "Без названия",
        confirm_delete: "Удалить этот чат?"
      },
      en: {
        new_chat: "New chat",
        placeholder: "Type a message…",
        send: "Send",
        typing: "AI is typing…",
        untitled: "Untitled",
        confirm_delete: "Delete this chat?"
      },
      uz: {
        new_chat: "Yangi chat",
        placeholder: "Xabar yozing…",
        send: "Yuborish",
        typing: "AI yozmoqda…",
        untitled: "Nomsiz",
        confirm_delete: "Ushbu chat o‘chirilsinmi?"
      }
    };

    // ================ DOM refs ================
    const $ = s => document.querySelector(s);
    const chatEl = $('#chat');
    const chatList = $('#chatList');
    const msg = $('#msg');
    const composer = $('#composer');
    const sendBtn = $('#sendBtn');
    const newChatBtn = $('#newChat');
    const chatTitleEl = $('#chatTitle');
    const langSel = $('#lang');
    const langSel2 = $('#lang2');
    const sidebar = $('#sidebar');
    const burger = $('#burger');

    // ============= Config / API =============
    const API = {
      XSPIN_URL: 'https://api.xspin.uz/zico.php',
      TIMEOUT: 20000
    };

    // =============== Storage ================
    const LS_CHATS_KEY = 'luma_multi_chats_v1';
    const LS_CURRENT_KEY = 'luma_current_chat_v1';
    const LS_LANG_KEY = 'luma_ui_lang_v1';

    let UI_LANG = localStorage.getItem(LS_LANG_KEY) || 'ru';
    langSel.value = UI_LANG; langSel2.value = UI_LANG;

    let chats = loadChats();
    let currentChatId = localStorage.getItem(LS_CURRENT_KEY) || null;

    function loadChats(){
      try {
        const raw = localStorage.getItem(LS_CHATS_KEY);
        const data = raw ? JSON.parse(raw) : { chats: [] };
        if (!Array.isArray(data.chats)) data.chats = [];
        return data;
      } catch { return { chats: [] }; }
    }
    function saveChats(){ localStorage.setItem(LS_CHATS_KEY, JSON.stringify(chats)); }
    function setCurrent(id){ currentChatId = id; localStorage.setItem(LS_CURRENT_KEY, id || ''); }

    // ============== Utils ==============
    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
    const escapeHtml = s => String(s ?? '').replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const scrollBottom = () => chatEl.scrollTop = chatEl.scrollHeight;
    const truncate = (s, n=40) => s.length>n ? s.slice(0, n-1)+'…' : s;

    function t(key){ return (I18N[UI_LANG] && I18N[UI_LANG][key]) || key; }
    function applyLocale(){
      newChatBtn.innerHTML = '＋ ' + t('new_chat');
      msg.placeholder = t('placeholder');
      sendBtn.textContent = t('send');
      // обновим всплывашки удаления (на кнопки ставим при рендере)
      renderSidebar();
    }

    // ============== Rendering ==============
    function renderSidebar(){
      chatList.innerHTML = '';
      chats.chats.forEach(c => {
        const item = document.createElement('div');
        item.className = 'chat-item' + (c.id === currentChatId ? ' active' : '');
        const title = c.title || t('untitled');
        item.innerHTML = `
          <div class="chat-title" title="${escapeHtml(title)}">${escapeHtml(title)}</div>
          <button class="del" title="Delete">🗑️</button>
        `;
        item.addEventListener('click', (e)=>{
          if (e.target.closest('.del')) return; // делегировано
          openChat(c.id);
          if (window.innerWidth <= 900) sidebar.classList.remove('open');
        });
        item.querySelector('.del').addEventListener('click', (e)=>{
          e.stopPropagation();
          if (!confirm(t('confirm_delete'))) return;
          deleteChat(c.id);
        });
        chatList.appendChild(item);
      });
    }

    function renderMessages(){
      const chat = getCurrentChat();
      chatEl.innerHTML = '';
      if (!chat) { chatTitleEl.textContent = '—'; return; }
      chatTitleEl.textContent = chat.title || t('untitled');
      const frag = document.createDocumentFragment();
      (chat.messages || []).forEach(m=>{
        frag.appendChild(rowNode(m.role, m.text));
      });
      chatEl.appendChild(frag);
      scrollBottom();
    }

    function rowNode(role, text){
      const row = document.createElement('div');
      row.className = 'row ' + role;
      row.innerHTML = `
        <div class="avatar">${role === 'user' ? '👤' : '✨'}</div>
        <div class="bubble">${escapeHtml(text)}</div>
      `;
      return row;
    }

    function typingRow(){
      const row = document.createElement('div');
      row.className = 'row ai';
      row.innerHTML = `
        <div class="avatar">✨</div>
        <div class="bubble">
          <span class="typing">
            <span class="dot"></span><span class="dot"></span><span class="dot"></span>
          </span>
        </div>
      `;
      chatEl.appendChild(row);
      scrollBottom();
      return row;
    }

    async function revealText(el, text){
      el.textContent = '';
      const s = String(text ?? '');
      let i = 0, chunk = 10;
      function frame(){
        i = Math.min(s.length, i + chunk);
        el.innerHTML = escapeHtml(s.slice(0, i)).replace(/\n/g,'<br/>');
        scrollBottom();
        if (i < s.length) requestAnimationFrame(frame);
      }
      requestAnimationFrame(frame);
    }

    // ============== Chat ops ==============
    function createChat(initialTitle){
      const id = uid();
      const chat = { id, title: initialTitle || '', createdAt: Date.now(), messages: [] };
      chats.chats.push(chat);
      saveChats();
      setCurrent(id);
      renderSidebar();
      renderMessages();
      return chat;
    }
    function openChat(id){
      setCurrent(id);
      renderSidebar();
      renderMessages();
    }
    function deleteChat(id){
      const idx = chats.chats.findIndex(c=>c.id===id);
      if (idx>=0){
        chats.chats.splice(idx,1);
        saveChats();
        if (currentChatId === id) {
          setCurrent(chats.chats[0]?.id || '');
        }
        renderSidebar();
        renderMessages();
      }
    }
    function getCurrentChat(){
      if (!currentChatId) return null;
      return chats.chats.find(c=>c.id===currentChatId) || null;
    }
    function pushMessage(role, text){
      const c = getCurrentChat();
      if (!c) return;
      c.messages.push({ role, text, ts: Date.now() });
      // предложим заголовок из первого пользовательского сообщения
      if (!c.title) {
        const first = c.messages.find(m=>m.role==='user')?.text || '';
        c.title = truncate(first || t('untitled'), 40);
      }
      saveChats();
    }

    // ============== Networking ==============
    async function askAPI(prompt){
      const controller = new AbortController();
      const timeout = setTimeout(()=>controller.abort(), API.TIMEOUT);
      try{
        // try POST
        let r = await fetch(API.XSPIN_URL, {
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded','Accept':'application/json'},
          body: new URLSearchParams({prompt}),
          signal: controller.signal
        });
        if (!r.ok){
          // GET fallback
          const url = API.XSPIN_URL + '?prompt=' + encodeURIComponent(prompt);
          r = await fetch(url, {headers:{'Accept':'application/json'}, signal: controller.signal});
        }
        clearTimeout(timeout);
        let data;
        try { data = await r.json(); }
        catch { data = { response: await r.text() }; }
        return (data && (data.response || data.answer)) || '…';
      } catch(e){
        clearTimeout(timeout);
        if (e.name === 'AbortError') return 'Таймаут запроса.';
        // типичная ситуация в чистом фронте: CORS
        return 'Failed to fetch (CORS/Network). Запусти страницу через http/https или настрой проксирование на своём домене.';
      }
    }

    // ============== Send flow ==============
    let sending = false;
    composer.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const text = msg.value.trim();
      if (!text || sending) return;

      // если чата нет — создадим
      if (!getCurrentChat()) createChat();

      sending = true; sendBtn.disabled = true;

      // USER message
      pushMessage('user', text);
      chatEl.appendChild(rowNode('user', text));
      msg.value = ''; autoResize(msg);

      // TYPING
      const tr = typingRow();

      // FETCH
      const answer = await askAPI(text);

      // Replace typing with streamed text
      try { tr.remove(); } catch {}
      const row = rowNode('ai', '');
      chatEl.appendChild(row);
      const bubble = row.querySelector('.bubble');
      await revealText(bubble, answer);

      // Save AI message
      pushMessage('ai', answer);

      renderSidebar(); // чтобы обновился заголовок, если впервые
      sending = false; sendBtn.disabled = false;
    });

    // ============== UI events ==============
    newChatBtn.addEventListener('click', ()=>{
      const c = createChat();
      renderSidebar();
      renderMessages();
      msg.focus();
    });

    [langSel, langSel2].forEach(sel => sel.addEventListener('change', (e)=>{
      UI_LANG = e.target.value;
      langSel.value = UI_LANG; langSel2.value = UI_LANG;
      localStorage.setItem(LS_LANG_KEY, UI_LANG);
      applyLocale();
    }));

    burger.addEventListener('click', ()=>{
      sidebar.classList.toggle('open');
    });

    // textarea autoresize
    function autoResize(el){
      el.style.height = 'auto';
      el.style.height = Math.min(el.scrollHeight, 180) + 'px';
    }
    msg.addEventListener('input', ()=>autoResize(msg));

    // ============== First paint ==============
    (function init(){
      // theme init
      const theme = localStorage.getItem('theme') || 'auto';
      document.documentElement.setAttribute('data-theme', theme);

      // ensure at least one chat exists
      if (!chats.chats.length){
        const c = createChat();
        pushMessage('ai', '👋 ' + (UI_LANG==='ru' ? 'Новый чат готов. Задайте вопрос!' : UI_LANG==='uz' ? 'Yangi chat tayyor. Savol bering!' : 'New chat is ready. Ask anything!'));
      }
      if (!currentChatId) setCurrent(chats.chats[0].id);

      renderSidebar();
      renderMessages();
      applyLocale();
      msg.focus();
    })();
  </script>
</body>
</html>
